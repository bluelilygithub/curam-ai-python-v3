<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Australian Property Intelligence V3 - User Analytics Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script> 
    

     <link rel="stylesheet" href="assets/css/styles.css">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Australian Property Intelligence</h1>
        </div>

        <div class="user-selector">
            <h3>üë• Experience Personalized Property Analytics</h3>
            <div class="user-buttons" id="userButtons">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading demo users...</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <div class="question-section">
                    <h2 id="sectionTitle">ü§ñ Select a User to Begin</h2>
                    
                    <div class="preset-questions" id="presetQuestions">
                        <div class="empty-state">
                            <span class="emoji">üëÜ</span>
                            <p>Choose a demo user above to see personalized property questions</p>
                        </div>
                    </div>

                    <div class="custom-input" style="display: none;" id="customInputSection">
                        <textarea id="customQuestion" placeholder="Ask your own property question..."></textarea>
                        <button class="analyze-btn" onclick="analyzeCustomQuestion()" id="analyzeBtn">Analyze</button>
                    </div>
                </div>

                <div id="results" style="display: none;">
                    </div>
            </div>

            <div class="sidebar">
                <div class="user-profile" id="userProfile">
                    <div class="empty-state">
                        <span class="emoji">üë§</span>
                        <h3>Select a Demo User</h3>
                        <p>Choose Sarah or Michael above to see their personalized property analytics</p>
                    </div>
                </div>

                <div class="query-history">
                    <h4>üìù Recent Searches</h4>
                    <div id="queryHistoryList">
                        <div class="empty-state">
                            <span class="emoji">üìã</span>
                            <p>User's search history will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="activity-log">
                    <h4>‚ö° Real-Time Activity</h4>
                    <div class="activity-feed" id="activityFeed">
                        <div class="empty-state">
                            <span class="emoji">üîÑ</span>
                            <p>System activity will appear here</p>
                        </div>
                    </div>
                </div>
            </div> </div>

        <div class="dashboard">
            <h3>üìä Real-Time System Analytics</h3>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let demoUsers = [];
        let performanceChart = null;
        let activityFeed = []; // This array might not be strictly needed if logs are only prepended to DOM
        const API_BASE = 'https://curam-ai-python-v3-production.up.railway.app';
        let eventSource = null; // Declare eventSource globally here.

        // User-specific preset questions
        const userPresets = {
            'sarah_buyer': [
                "Best suburbs under $600k for first home buyers in Brisbane",
                "Units near train stations in Brisbane",
                "First home buyer grants and assistance",
                "Safest affordable suburbs for young professionals"
            ],
            'michael_investor': [
                "High rental yield suburbs in Brisbane",
                "Investment property hotspots 2025",
                "Logan vs Ipswich for property investment",
                "Brisbane outer suburbs with growth potential"
            ]
        };

        // --- Core Activity Log Function ---
        // This function adds a new entry to the activity log.
        // It's used by both the initial frontend load and the SSE stream.
        function addActivity(type, emoji, title, message, details = {}) {
            const activityFeedDiv = document.getElementById('activityFeed');
            if (!activityFeedDiv) {
                console.error("Activity log div with ID 'activityFeed' not found!");
                return;
            }

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let detailsHtml = '';
            // Format timestamp specifically for display
            if (details.timestamp) {
                const ts = new Date(details.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                detailsHtml += `<span class="timestamp">${ts}</span>`;
            }
            
            // Convert other details (if any) to pre-formatted JSON
            const otherDetails = { ...details };
            delete otherDetails.timestamp; // Remove timestamp if already displayed in its own span

            if (Object.keys(otherDetails).length > 0) {
                detailsHtml += `<pre>${JSON.stringify(otherDetails, null, 2)}</pre>`;
            }

            logEntry.innerHTML = `
                <span class="emoji">${emoji}</span>
                <div class="log-content">
                    <strong>${title}</strong>
                    <p>${message}</p>
                </div>
                <div class="log-details">${detailsHtml}</div>
            `;
            activityFeedDiv.prepend(logEntry); // Add new logs to the top

            // Optional: Limit number of logs to prevent UI overload
            if (activityFeedDiv.children.length > 50) { // Limit to 50 logs
                activityFeedDiv.removeChild(activityFeedDiv.lastChild);
            }
        }


        // Initialize application (no change needed here for `initLiveLogStream` call)
        async function initApp() {
            try {
                console.log('üöÄ Initializing Australian Property Intelligence V3...');

                // Initialize the live log stream first
                initLiveLogStream();
                addActivity('connecting', 'üîó', 'System Status', 'Waiting for live log stream from backend...');

                // Now proceed with other initializations
                await loadDemoUsers();
                await loadSystemStats();
                setupPerformanceChart();

                console.log('‚úÖ Application initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                addActivity('error', 'üö®', 'App Initialization Failed', `Failed to initialize application: ${error.message}`, { status: 'Error' });
                showError('Failed to initialize application. Please refresh the page.');
            }
        }

        // Function to set up and manage the SSE connection for live logs
        function initLiveLogStream() {
            if (eventSource) {
                eventSource.close(); // Close existing connection if any
                console.log("Closed existing EventSource connection.");
            }

            eventSource = new EventSource(`${API_BASE}/stream_logs`);

            eventSource.onmessage = function(event) {
                try {
                    const logData = JSON.parse(event.data);
                    
                    // Only process if it's a valid log message (not a keep-alive or empty)
                    if (!logData.message) {
                        return; // Skip empty keep-alive messages
                    }

                    // --- Filtering Logic (Exclude obvious UI actions) ---
                    const excludedMessages = [
                        "Live log stream handler initialized and attached to root logger.",
                        "Connecting to user management API...",
                        "Found 2 demo users: Sarah Chen, Michael Rodriguez",
                        "Now viewing Sarah Chen's personalized analytics",
                        "Now viewing Michael Rodriguez's personalized analytics",
                        "Starting Australian Property Intelligence API V3.0", // This is logged on backend start, but can be skipped if you have a cleaner "API Online" message
                        "Port:", "Debug:", "Database:", "User Switching:", // Startup config logs
                        "Services initialized:", // Combined service initialization success
                        "LLM service initialized", // Initial service status (often followed by model tests)
                        "RSS service initialized",
                        "Property analysis service initialized",
                        "Health checker initialized",
                        "PostgreSQL database service initialized" // Initial DB connection
                    ];

                    // Check if the message should be filtered out
                    if (excludedMessages.some(msg => logData.message.includes(msg))) {
                        return; // Skip this log entry
                    }

                    // --- Intelligent Emoji and Type Assignment ---
                    let emoji = '‚ÑπÔ∏è'; // Default for INFO
                    let type = 'info'; // Default type
                    let title = logData.level; // Start title with log level

                    switch (logData.level) {
                        case 'INFO':
                            // Specific backend activities
                            if (logData.message.includes("CLAUDE PROMPT BEING SENT")) {
                                emoji = 'üìù'; type = 'processing'; title = 'Claude Prompt';
                                logData.message = "Sending prompt to Claude..."; // Shorten message for log view
                            } else if (logData.message.includes("GEMINI PROMPT BEING SENT")) {
                                emoji = 'üìù'; type = 'processing'; title = 'Gemini Prompt';
                                logData.message = "Sending prompt to Gemini..."; // Shorten message for log view
                            } else if (logData.message.includes("Retrieved") && logData.message.includes("articles")) {
                                emoji = 'üì•'; type = 'success'; title = 'RSS Data Retrieved';
                            } else if (logData.message.includes("Converted") && logData.message.includes("articles to data sources")) {
                                emoji = 'üìä'; type = 'success'; title = 'RSS Data Processed';
                            } else if (logData.message.includes("LOCATION DETECTION")) {
                                emoji = 'üìç'; type = 'info'; title = 'Location Detected';
                                // Extract location for display in details
                                const match = logData.message.match(/LOCATION DETECTION FINAL RESULT: \{'scope': '([^']*)'/);
                                if (match && match[1]) {
                                    logData.details = { scope: match[1] };
                                    logData.message = `Location detected: ${match[1]}`;
                                }
                            } else if (logData.message.includes("Claude model") && logData.message.includes("working")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Claude Model Test';
                            } else if (logData.message.includes("Gemini initialized with model")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Gemini Model Test';
                            } else if (logData.message.includes("Processing property question")) {
                                emoji = 'üîç'; type = 'processing'; title = 'Processing Question';
                            } else if (logData.message.includes("Query stored")) {
                                emoji = 'üíæ'; type = 'success'; title = 'Query Stored';
                            } else if (logData.message.includes("Analysis completed")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Analysis Complete';
                            } else if (logData.message.includes("Get demo users error")) {
                                emoji = 'üë•'; type = 'error'; title = 'User Load Error';
                            } else if (logData.message.includes("Get user statistics error")) {
                                emoji = 'üìä'; type = 'error'; title = 'User Stats Error';
                            } else if (logData.message.includes("Get user history error")) {
                                emoji = 'üìù'; type = 'error'; title = 'User History Error';
                            } else if (logData.message.includes("Property analysis error")) {
                                emoji = '‚ùå'; type = 'error'; title = 'Analysis Error';
                            } else if (logData.message.includes("Get questions error")) {
                                emoji = '‚ùì'; type = 'error'; title = 'Questions Error';
                            } else if (logData.message.includes("Failed to get popular questions")) {
                                emoji = 'üìà'; type = 'error'; title = 'Popular Qs Error';
                            } else if (logData.message.includes("Get history error")) {
                                emoji = 'üìú'; type = 'error'; title = 'History Error';
                            } else if (logData.message.includes("Get stats error")) {
                                emoji = 'üìä'; type = 'error'; title = 'Stats Error';
                            } else if (logData.message.includes("LLM performance analysis failed")) {
                                emoji = 'üìâ'; type = 'error'; title = 'Perf Analysis Error';
                            } else if (logData.message.includes("Failed to store query")) {
                                emoji = 'üíæ'; type = 'error'; title = 'DB Store Error';
                            }
                            break;
                        case 'WARNING':
                            emoji = '‚ö†Ô∏è'; type = 'warning'; title = 'Warning';
                            if (logData.message.includes("API key not configured")) {
                                title = 'API Key Missing';
                            } else if (logData.message.includes("service not available")) {
                                title = 'Service Unavailable';
                            }
                            break;
                        case 'ERROR':
                            emoji = '‚ùå'; type = 'error'; title = 'Error';
                            break;
                        case 'DEBUG':
                            emoji = 'üêõ'; type = 'debug'; title = 'Debug';
                            break;
                    }

                    // Add logger name to title if available and not 'app' or main
                    if (logData.name && logData.name !== '__main__' && logData.name !== 'app') {
                         title += ` (${logData.name.split('.').pop()})`; // e.g., (llm_service), (enhanced_database)
                    }

                    // Prepare details object for addActivity (combining existing details with logData.details)
                    const activityDetails = logData.details || {}; // Use logData.details if already set in filtering
                    if (logData.timestamp) activityDetails.timestamp = logData.timestamp;


                    // Call addActivity with the processed data
                    addActivity(type, emoji, title, logData.message, activityDetails);

                } catch (e) {
                    console.error("Failed to parse log message or process it:", e, event.data);
                    addActivity('error', 'üö®', 'Log Parser Error', `Could not parse log message (check console): ${event.data.substring(0, 100)}...`, { error: e.message });
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                addActivity('error', 'üö®', 'Log Stream Error', 'Lost connection to live log stream. Attempting to reconnect...', { error: err.message || 'Unknown error' });
            };

            console.log('üîó Attempting to connect to live log stream.');
        }

        // Load demo users from API
        async function loadDemoUsers() {
            try {
                // This message is now managed by the live log stream, remove redundant addActivity
                // addActivity('connecting', 'üë•', 'Loading Demo Users', 'Connecting to user management API...', { status: 'Loading' });
                
                const response = await fetch(`${API_BASE}/api/users`);
                const data = await response.json();
                
                if (data.success) {
                    demoUsers = data.users;
                    renderUserButtons();
                    // This message is now managed by the live log stream, remove redundant addActivity
                    // addActivity('success', '‚úÖ', 'Demo Users Loaded', `Found ${demoUsers.length} demo users: ${demoUsers.map(u => u.name).join(', ').substring(0, 50)}...`, { users: demoUsers.length });
                    console.log(`‚úÖ Loaded ${demoUsers.length} demo users`);
                } else {
                    throw new Error(data.error || 'Failed to load users');
                }
            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                addActivity('error', '‚ùå', 'Failed to Load Users', error.message, { status: 'Error' });
                showError('Failed to load demo users');
            }
        }

        // Render user selection buttons
        function renderUserButtons() {
            const container = document.getElementById('userButtons');
            container.innerHTML = '';

            demoUsers.forEach(user => {
                const button = document.createElement('button');
                button.className = 'user-btn';
                button.setAttribute('data-user', user.user_id);
                button.onclick = () => switchUser(user.user_id);

                // Enhanced button content
                button.innerHTML = `
                    <div class="user-name">${user.avatar} ${user.name}</div>
                    <div class="user-type">${getProfileTypeLabel(user.profile_type)}</div>
                    <div class="user-preview">${user.description}</div>
                `;

                container.appendChild(button);
            });
        }

        // Get user-friendly profile type labels
        function getProfileTypeLabel(profileType) {
            const labels = {
                'first_buyer': 'First Home Buyer',
                'investor': 'Property Investor'
            };
            return labels[profileType] || profileType;
        }

        // Switch to different user
        async function switchUser(userId) {
            try {
                console.log(`üîÑ Switching to user: ${userId}`);
                currentUser = userId;
                const user = demoUsers.find(u => u.user_id === userId);
                
                // This message is now managed by the live log stream, remove redundant addActivity
                // addActivity('processing', 'üîÑ', 'User Switch', `Switching to ${user.name} (${getProfileTypeLabel(user.profile_type)})`, { user: user.name });
                
                // Update UI to show active user
                document.querySelectorAll('.user-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-user="${userId}"]`).classList.add('active');

                // Show loading states
                document.getElementById('userProfile').classList.add('loading');
                document.getElementById('sectionTitle').textContent = 'üîÑ Loading user data...';

                // Load user data
                await loadUserStats(userId);
                renderPresetQuestions(userId);
                
                // Show custom input section
                document.getElementById('customInputSection').style.display = 'flex';
                
                // Update section title
                document.getElementById('sectionTitle').textContent = 
                    `ü§ñ ${user.name}'s Property Analysis`;
                
                // Clear any existing results
                document.getElementById('results').style.display = 'none';

                // This message is now managed by the live log stream, remove redundant addActivity
                // addActivity('success', '‚úÖ', 'User Switch Complete', `Now viewing ${user.name}'s personalized analytics`, { status: 'Active' });
                console.log(`‚úÖ Successfully switched to ${user.name}`);
                
            } catch (error) {
                console.error('‚ùå Error switching user:', error);
                addActivity('error', '‚ùå', 'User Switch Failed', error.message, { status: 'Error' });
                showError('Failed to switch user');
            }
        }

        // Load user statistics
        async function loadUserStats(userId) {
            try {
                // This message is now managed by the live log stream, remove redundant addActivity
                // addActivity('connecting', 'üìä', 'Loading User Stats', `Fetching analytics for ${userId}...`, { status: 'Loading' });
                
                const response = await fetch(`${API_BASE}/api/users/${userId}/stats`);
                const data = await response.json();
                
                if (data.success) {
                    updateUserProfile(data.data);
                    // This message is now managed by the live log stream, remove redundant addActivity
                    // addActivity('success', 'üìà', 'User Stats Loaded', `Analytics loaded: ${data.data.stats.total_queries} queries, ${data.data.stats.avg_processing_time}s avg time`, { 
                    //     queries: data.data.stats.total_queries,
                    //     time: `${data.data.stats.avg_processing_time}s`
                    // });
                    console.log(`‚úÖ Loaded stats for ${userId}`);
                } else {
                    throw new Error(data.error || 'Failed to load user stats');
                }
            } catch (error) {
                console.error('‚ùå Error loading user stats:', error);
                addActivity('error', '‚ùå', 'Stats Load Failed', error.message, { status: 'Error' });
                showError('Failed to load user statistics');
            }
        }

        // Update user profile display
        function updateUserProfile(userData) {
            const profileContainer = document.getElementById('userProfile');
            profileContainer.classList.remove('loading');
            
            profileContainer.innerHTML = `
                <div class="user-avatar">${userData.user.avatar}</div>
                <h3>${userData.user.name}</h3>
                <div class="profile-type">${getProfileTypeLabel(userData.user.profile_type)}</div>
                <div class="user-description">${userData.user.description}</div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value">${userData.stats.total_queries}</div>
                        <div class="stat-label">Queries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${userData.stats.avg_processing_time}s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            `;

            // Update query history
            updateQueryHistory(userData.recent_queries);
        }

        // Update query history display
        function updateQueryHistory(queries) {
            const historyContainer = document.getElementById('queryHistoryList');
            
            if (!queries || queries.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üÜï</span>
                        <p>No queries yet. Start by asking a question!</p>
                    </div>
                `;
                return;
            }

            historyContainer.innerHTML = '';
            
            queries.forEach(query => {
                const item = document.createElement('div');
                item.className = 'query-item fade-in';
                
                const timeAgo = getTimeAgo(query.created_at);
                
                item.innerHTML = `
                    <div class="query-question">${query.question}</div>
                    <div class="query-meta">
                        <span class="query-location">${query.location || 'National'}</span>
                        <span>${timeAgo} ‚Ä¢ ${query.processing_time}s</span>
                    </div>
                `;
                historyContainer.appendChild(item);
            });
        }

        // Get time ago string
        function getTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Render preset questions for current user
        function renderPresetQuestions(userId) {
            const container = document.getElementById('presetQuestions');
            const questions = userPresets[userId] || [];
            
            container.innerHTML = '';
            
            questions.forEach(question => {
                const button = document.createElement('button');
                button.className = 'preset-btn fade-in';
                button.textContent = question;
                button.onclick = () => analyzeQuestion(question);
                container.appendChild(button);
            });
        }

        // Analyze property question with enhanced activity logging
async function analyzeQuestion(question) {
    if (!currentUser) {
        alert('Please select a user first');
        return;
    }

    const user = demoUsers.find(u => u.user_id === currentUser);
    // Removed direct addActivity for starting analysis as it's now logged from backend.

    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Analyzing property question for ${user?.name}...</p>
        </div>
    `;

    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth' });

    try {
        console.log(`üîç Analyzing question for ${currentUser}: ${question}`);
        
        const response = await fetch(`${API_BASE}/api/property/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question: question,
                user_id: currentUser
            })
        });

        const data = await response.json();

        if (data.success) {
            // Removed direct addActivity for analysis complete as it's now logged from backend.
            
            // --- CRITICAL CHANGE HERE: Use marked.parse() ---
            const formattedAnswerHtml = marked.parse(data.answer || ''); // Render Markdown to HTML

            resultsDiv.innerHTML = `
                <div class="results fade-in">
                    <h3>üìã Analysis Results for ${user?.name}</h3>
                    <div class="analysis-content">${formattedAnswerHtml}</div> <div class="metadata">
                        <div class="metadata-item">
                            <span><strong>Location:</strong></span>
                            <span>${data.metadata.location_detected}</span>
                        </div>
                        <div class="metadata-item">
                            <span><strong>Processing Time:</strong></span>
                            <span>${data.processing_time}s</span>
                        </div>
                        <div class="metadata-item">
                            <span><strong>LLM Provider:</strong></span>
                            <span>${data.metadata.llm_provider}</span>
                        </div>
                        <div class="metadata-item">
                            <span><strong>Confidence:</strong></span>
                            <span>${Math.round(data.metadata.confidence * 100)}%</span>
                        </div>
                        <div class="metadata-item">
                            <span><strong>Query ID:</strong></span>
                            <span>#${data.query_id}</span>
                        </div>
                        <div class="metadata-item">
                            <span><strong>User:</strong></span>
                            <span>${currentUser}</span>
                        </div>
                    </div>
                </div>
            `;

            // Refresh user stats and charts
            await loadUserStats(currentUser);
            await loadSystemStats();
            
            console.log(`‚úÖ Analysis completed for ${currentUser}`);
        } else {
            addActivity('error', '‚ùå', 'Analysis Failed', data.error || 'Unknown error occurred', { status: 'Error' });
            
            resultsDiv.innerHTML = `
                <div class="results">
                    <h3>‚ùå Analysis Failed</h3>
                    <p>Sorry, we couldn't analyze your question. Please try again.</p>
                    <p class="error-details">${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Error analyzing question:', error);
        addActivity('error', '‚ùå', 'Analysis Error', error.message, { status: 'Error' });
        
        resultsDiv.innerHTML = `
            <div class="results">
                <h3>‚ùå Error</h3>
                <p>An error occurred while analyzing your question.</p>
                <p class="error-details">${error.message}</p>
            </div>
        `;
    }
}


        // Analyze custom question
        function analyzeCustomQuestion() {
            const question = document.getElementById('customQuestion').value.trim();
            if (question) {
                analyzeQuestion(question);
                document.getElementById('customQuestion').value = '';
            }
        }

        // Load system statistics for dashboard
        async function loadSystemStats() {
            try {
                const response = await fetch(`${API_BASE}/api/property/stats`);
                const data = await response.json();
                
                if (data.success && performanceChart) {
                    updatePerformanceChart(data.stats);
                    console.log('‚úÖ System stats updated');
                }
            } catch (error) {
                console.error('‚ùå Error loading system stats:', error);
            }
        }

        // Setup performance chart
        function setupPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Times (seconds)',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4facfe',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Recent Query Response Times by User',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (seconds)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Recent Queries'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Update performance chart with new data
        function updatePerformanceChart(stats) {
            if (!stats.llm_performance || !stats.llm_performance.response_times) {
                return;
            }

            const times = stats.llm_performance.response_times;
            
            if (times && times.length > 0) {
                const labels = times.map((_, index) => `Query ${index + 1}`);
                const data = times.map(item => item.processing_time);
                
                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = data;
                performanceChart.update('none'); // No animation for better performance
            }
        }

        // Error handling
        function showError(message) {
            console.error('‚ùå', message);
            
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: 600;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Enter key support for custom questions
        document.addEventListener('DOMContentLoaded', function() {
            const customQuestion = document.getElementById('customQuestion');
            if (customQuestion) {
                customQuestion.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        analyzeCustomQuestion();
                    }
                });
            }
        });

        // Auto-refresh system stats every 60 seconds
        setInterval(loadSystemStats, 60000);

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Add some demo data if no users loaded (fallback)
        function addFallbackUsers() {
            if (demoUsers.length === 0) {
                demoUsers = [
                    {
                        user_id: 'sarah_buyer',
                        name: 'Sarah Chen',
                        profile_type: 'first_buyer',
                        description: 'First home buyer focused on affordability and transport links',
                        avatar: 'üë©‚Äçüíº'
                    },
                    {
                        user_id: 'michael_investor',
                        name: 'Michael Rodriguez',
                        profile_type: 'investor',
                        description: 'Property investor focused on rental yield and growth',
                        avatar: 'üë®‚Äçüíª'
                    }
                ];
                renderUserButtons();
                addActivity('success', 'üîÑ', 'Fallback Users Loaded', 'Using demo user data for demonstration', { status: 'Demo Mode' });
                console.log('‚ÑπÔ∏è Using fallback demo users');
            }
        }

        // Initialize fallback after 3 seconds if no users loaded
        setTimeout(() => {
            if (demoUsers.length === 0) {
                addFallbackUsers();
            }
        }, 3000);

        // Enhanced logging for debugging
        window.addEventListener('load', () => {
            console.log('üéâ Australian Property Intelligence V3 Frontend Loaded');
            console.log('üîó API Base:', API_BASE);
            console.log('üë• Demo Users:', demoUsers.length);
        });

        // Handle offline/online states
        window.addEventListener('online', () => {
            console.log('üåê Back online');
            addActivity('success', 'üåê', 'Connection Restored', 'Back online - all features available', { status: 'Online' });
            loadSystemStats();
            // EventSource automatically attempts to reconnect, so manual initLiveLogStream() call here is not strictly necessary
        });

        window.addEventListener('offline', () => {
            console.log('üì° Gone offline');
            addActivity('error', 'üì°', 'Connection Lost', 'Offline mode - some features may not work', { status: 'Offline' });
            showError('Connection lost. Some features may not work.');
        });
    </script>
</body>
</html>
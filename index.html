<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Australian Property Intelligence V3 - User Analytics Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script> 
    
    <link rel="stylesheet" href="assets/css/styles.css">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Australian Property Intelligence</h1>
        </div>

        <div class="user-selector">
            <h3>üë• Experience Personalized Property Analytics</h3>
            <div class="user-buttons" id="userButtons">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading demo users...</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <div class="question-section">
                    <h2 id="sectionTitle">ü§ñ Select a User to Begin</h2>
                    
                    <div class="preset-questions" id="presetQuestions">
                        <div class="empty-state">
                            <span class="emoji">üëÜ</span>
                            <p>Choose a demo user above to see personalized property questions</p>
                        </div>
                    </div>

                    <div class="custom-input" style="display: none;" id="customInputSection">
                        <textarea id="customQuestion" placeholder="Ask your own property question..."></textarea>
                        <button class="microphone-btn" onclick="startVoiceInput()" id="microphoneBtn" title="Ask a question using your voice">
                            üéôÔ∏è
                        </button>
                        <button class="analyze-btn" onclick="analyzeCustomQuestion()" id="analyzeBtn">Analyze</button>
                    </div>
                </div>

                <div id="results" style="display: none;">
                    </div>
            </div>

            <div class="sidebar">
                <div class="user-profile" id="userProfile">
                    <div class="empty-state">
                        <span class="emoji">üë§</span>
                        <h3>Select a Demo User</h3>
                        <p>Choose Sarah or Michael above to see their personalized property analytics</p>
                    </div>
                    <div class="llm-usage-details" id="llmUsageDetails" style="display: none;">
                        <h4>LLM Usage:</h4>
                        <div class="usage-meter">
                            <span id="questionTokens" class="token-count">Current Query: 0 tokens</span>
                            <span id="sessionTokens" class="token-count">Session Total: 0 / 0 tokens</span>
                            <div class="progress-bar-container">
                                <div id="sessionProgressBar" class="progress-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="query-history">
                    <h4>üìù Recent Searches</h4>
                    <div id="queryHistoryList">
                        <div class="empty-state">
                            <span class="emoji">üìã</span>
                            <p>User's search history will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="activity-log">
                    <h4>‚ö° Real-Time Activity</h4>
                    <div class="activity-feed" id="activityFeed">
                        <div class="empty-state">
                            <span class="emoji">üîÑ</span>
                            <p>System activity will appear here</p>
                        </div>
                    </div>
                </div>
            </div> </div>

        <div class="dashboard">
            <h3>üìä Real-Time System Analytics</h3>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let demoUsers = [];
        let performanceChart = null;
        let activityFeed = []; 
        const API_BASE = 'https://curam-ai-python-v3-production.up.railway.app';
        let eventSource = null; 

        // --- Web Speech API Globals ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        // --- NEW: Global variables for token display ---
        let currentQueryTokens = 0;
        let sessionTotalTokens = 0;
        let maxSessionTokens = 0; // This will be loaded from API
        // --- END Web Speech API Globals ---


        // User-specific preset questions (now primarily for fallback if API fails)
        const userPresets = {
            'sarah_buyer': [
                "Best suburbs under $600k for first home buyers in Brisbane",
                "Units near train stations in Brisbane",
                "First home buyer grants and assistance",
                "Safest affordable suburbs for young professionals"
            ],
            'michael_investor': [
                "High rental yield suburbs in Brisbane",
                "Investment property hotspots 2025",
                "Logan vs Ipswich for property investment",
                "Brisbane outer suburbs with growth potential"
            ]
        };

        // --- Core Activity Log Function ---
        function addActivity(type, emoji, title, message, details = {}) {
            const activityFeedDiv = document.getElementById('activityFeed');
            if (!activityFeedDiv) {
                console.error("Activity log div with ID 'activityFeed' not found!");
                return;
            }

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let detailsHtml = '';
            if (details.timestamp) {
                const ts = new Date(details.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                detailsHtml += `<span class="timestamp">${ts}</span>`;
            }
            
            const otherDetails = { ...details };
            delete otherDetails.timestamp;

            if (Object.keys(otherDetails).length > 0) {
                detailsHtml += `<pre>${JSON.stringify(otherDetails, null, 2)}</pre>`;
            }

            logEntry.innerHTML = `
                <span class="emoji">${emoji}</span>
                <div class="log-content">
                    <strong>${title}</strong>
                    <p>${message}</p>
                </div>
                <div class="log-details">${detailsHtml}</div>
            `;
            activityFeedDiv.prepend(logEntry);

            if (activityFeedDiv.children.length > 50) {
                activityFeedDiv.removeChild(activityFeedDiv.lastChild);
            }
        }


        // Initialize application
        async function initApp() {
            try {
                console.log('üöÄ Initializing Australian Property Intelligence V3...');

                initLiveLogStream();
                addActivity('connecting', 'üîó', 'System Status', 'Waiting for live log stream from backend...');

                await loadDemoUsers(); 
                
                await loadSystemStats();
                setupPerformanceChart();
                setupSpeechRecognition(); 

                console.log('‚úÖ Application initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                addActivity('error', 'üö®', 'App Initialization Failed', `Failed to initialize application: ${error.message}`, { status: 'Error' });
                showError('Failed to initialize application. Please refresh the page.');
            }
        }

        // Function to set up and manage the SSE connection for live logs
        function initLiveLogStream() {
            if (eventSource) {
                eventSource.close();
                console.log("Closed existing EventSource connection.");
            }

            eventSource = new EventSource(`${API_BASE}/stream_logs`);

            eventSource.onmessage = function(event) {
                try {
                    const logData = JSON.parse(event.data);
                    
                    // NEW: Handle special 'token_update' action from backend
                    if (logData.action === "token_update") { 
                        currentQueryTokens = logData.current_query_tokens;
                        sessionTotalTokens = logData.session_total_tokens;
                        maxSessionTokens = logData.max_session_tokens;
                        updateTokenDisplay(); // Update the UI with new token values
                        return; // Do not process this as a regular log entry
                    }

                    if (!logData.message) {
                        return;
                    }

                    const excludedMessages = [
                        "Live log stream handler initialized and attached to root logger.",
                        "Connecting to user management API...",
                        "Found 2 demo users: Sarah Chen, Michael Rodriguez",
                        "Now viewing Sarah Chen's personalized analytics",
                        "Now viewing Michael Rodriguez's personalized analytics",
                        "Starting Australian Property Intelligence API V3.0",
                        "Port:", "Debug:", "Database:", "User Switching:",
                        "Services initialized:",
                        "LLM service initialized",
                        "RSS service initialized",
                        "Property analysis service initialized",
                        "Health checker initialized",
                        "PostgreSQL database service initialized"
                    ];

                    if (excludedMessages.some(msg => logData.message.includes(msg))) {
                        return;
                    }

                    let emoji = '‚ÑπÔ∏è';
                    let type = 'info';
                    let title = logData.level;

                    switch (logData.level) {
                        case 'INFO':
                            if (logData.message.includes("CLAUDE PROMPT BEING SENT")) {
                                emoji = 'üìù'; type = 'processing'; title = 'Claude Prompt';
                                logData.message = "Sending prompt to Claude...";
                            } else if (logData.message.includes("GEMINI PROMPT BEING SENT")) {
                                emoji = 'üìù'; type = 'processing'; title = 'Gemini Prompt';
                                logData.message = "Sending prompt to Gemini...";
                            } else if (logData.message.includes("Retrieved") && logData.message.includes("articles")) {
                                emoji = 'üì•'; type = 'success'; title = 'RSS Data Retrieved';
                            } else if (logData.message.includes("Converted") && logData.message.includes("articles to data sources")) {
                                emoji = 'üìä'; type = 'success'; title = 'RSS Data Processed';
                            } else if (logData.message.includes("LOCATION DETECTION")) {
                                emoji = 'üìç'; type = 'info'; title = 'Location Detected';
                                const match = logData.message.match(/LOCATION DETECTION FINAL RESULT: \{'scope': '([^']*)'/);
                                if (match && match[1]) {
                                    logData.details = { scope: match[1] };
                                    logData.message = `Location detected: ${match[1]}`;
                                }
                            } else if (logData.message.includes("Claude model") && logData.message.includes("working")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Claude Model Test';
                            } else if (logData.message.includes("Gemini initialized with model")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Gemini Model Test';
                            } else if (logData.message.includes("Processing property question")) {
                                emoji = 'üîç'; type = 'processing'; title = 'Processing Question';
                            } else if (logData.message.includes("Query stored")) {
                                emoji = 'üíæ'; type = 'success'; title = 'Query Stored';
                            } else if (logData.message.includes("Analysis completed")) {
                                emoji = '‚úÖ'; type = 'success'; title = 'Analysis Complete';
                            } else if (logData.message.includes("Get demo users error")) {
                                emoji = 'üë•'; type = 'error'; title = 'User Load Error';
                            } else if (logData.message.includes("Get user statistics error")) {
                                emoji = 'üìä'; type = 'error'; title = 'User Stats Error';
                            } else if (logData.message.includes("Get user history error")) {
                                emoji = 'üìù'; type = 'error'; title = 'User History Error';
                            } else if (logData.message.includes("Property analysis error")) {
                                emoji = '‚ùå'; type = 'error'; title = 'Analysis Error';
                            } else if (logData.message.includes("Get questions error")) {
                                emoji = '‚ùì'; type = 'error'; title = 'Questions Error';
                            } else if (logData.message.includes("Failed to get popular questions")) {
                                emoji = 'üìà'; type = 'error'; title = 'Popular Qs Error';
                            } else if (logData.message.includes("Get history error")) {
                                emoji = 'üìú'; type = 'error'; title = 'History Error';
                            } else if (logData.message.includes("Get stats error")) {
                                emoji = 'üìä'; type = 'error'; title = 'Stats Error';
                            } else if (logData.message.includes("LLM performance analysis failed")) {
                                emoji = 'üìâ'; type = 'error'; title = 'Perf Analysis Error';
                            } else if (logData.message.includes("Failed to store query")) {
                                emoji = 'üíæ'; type = 'error'; title = 'DB Store Error';
                            }
                            break;
                        case 'WARNING':
                            emoji = '‚ö†Ô∏è'; type = 'warning'; title = 'Warning';
                            if (logData.message.includes("API key not configured")) {
                                title = 'API Key Missing';
                            } else if (logData.message.includes("service not available")) {
                                title = 'Service Unavailable';
                            } else if (logData.message.includes("reached session token limit")) { // NEW: Token limit warning
                                emoji = 'üö´'; type = 'error'; title = 'Token Limit Reached';
                            }
                            break;
                        case 'ERROR':
                            emoji = '‚ùå'; type = 'error'; title = 'Error';
                            break;
                        case 'DEBUG':
                            emoji = 'üêõ'; type = 'debug'; title = 'Debug';
                            break;
                    }

                    if (logData.name && logData.name !== '__main__' && logData.name !== 'app') {
                         title += ` (${logData.name.split('.').pop()})`;
                    }

                    const activityDetails = logData.details || {};
                    if (logData.timestamp) activityDetails.timestamp = logData.timestamp;

                    addActivity(type, emoji, title, logData.message, activityDetails);

                } catch (e) {
                    console.error("Failed to parse log message or process it:", e, event.data);
                    addActivity('error', 'üö®', 'Log Parser Error', `Could not parse log message (check console): ${event.data.substring(0, 100)}...`, { error: e.message });
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                addActivity('error', 'üö®', 'Log Stream Error', 'Lost connection to live log stream. Attempting to reconnect...', { error: err.message || 'Unknown error' });
            };

            console.log('üîó Attempting to connect to live log stream.');
        }

        // --- Web Speech API Functions ---
        function setupSpeechRecognition() {
            if (!SpeechRecognition) {
                console.warn('Web Speech API not supported by this browser.');
                document.getElementById('microphoneBtn').disabled = true;
                addActivity('warning', 'üö´', 'Voice Input', 'Web Speech API not supported. Microphone input unavailable.', { browser: 'Unsupported' });
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true; 
            recognition.lang = 'en-AU';

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('microphoneBtn').classList.add('listening');
                document.getElementById('microphoneBtn').textContent = 'üî¥';
                document.getElementById('customQuestion').placeholder = "Listening... speak now!";
                document.getElementById('customQuestion').value = ""; 
                addActivity('info', 'üéôÔ∏è', 'Voice Input', 'Microphone active. Waiting for your question...', { status: 'Listening' });
                console.log('üéôÔ∏è Speech recognition started.');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const customQuestionInput = document.getElementById('customQuestion');
                customQuestionInput.value = finalTranscript || interimTranscript;

                if (event.results[event.resultIndex].isFinal) {
                    isListening = false;
                    document.getElementById('microphoneBtn').classList.remove('listening');
                    document.getElementById('microphoneBtn').textContent = 'üéôÔ∏è';
                    customQuestionInput.placeholder = "Ask your own property question...";
                    addActivity('success', 'üó£Ô∏è', 'Voice Input', `Question captured: "${finalTranscript.substring(0, 50)}..."`, { text: finalTranscript });
                    console.log('üó£Ô∏è Speech recognized (final):', finalTranscript);
                    
                    if (finalTranscript.trim().length > 0) {
                        analyzeCustomQuestion(); 
                    } else {
                        addActivity('warning', 'üéôÔ∏è', 'Voice Input', 'No significant speech captured. Please try again.', { status: 'No Speech Final' });
                        console.warn('‚ö†Ô∏è Final result was empty or too short.');
                    }
                } else {
                    console.log('üëÇ Interim speech recognized:', interimTranscript);
                }
            };

            recognition.onerror = (event) => {
                isListening = false;
                document.getElementById('microphoneBtn').classList.remove('listening');
                document.getElementById('microphoneBtn').textContent = 'üéôÔ∏è';
                document.getElementById('customQuestion').placeholder = "Ask your own property question...";
                addActivity('error', 'üéôÔ∏è', 'Voice Input Error', `Error: ${event.error}. Try again.`, { error_code: event.error });
                console.error('‚ùå Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showError('Microphone access denied. Please allow microphone permissions for this site.');
                } else if (event.error === 'no-speech') {
                    addActivity('warning', 'üéôÔ∏è', 'Voice Input', 'No speech detected. Please try again.', { status: 'No Speech' });
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    isListening = false;
                    document.getElementById('microphoneBtn').classList.remove('listening');
                    document.getElementById('microphoneBtn').textContent = 'üéôÔ∏è';
                    document.getElementById('customQuestion').placeholder = "Ask your own property question...";
                    if (document.getElementById('customQuestion').value.trim() === "") {
                         addActivity('info', 'üéôÔ∏è', 'Voice Input', 'Microphone session timed out or no clear speech. Ready for next question.', { status: 'Ended Timeout' });
                    } else {
                         addActivity('info', 'üéôÔ∏è', 'Voice Input', 'Microphone session ended. Ready for next question.', { status: 'Ended' });
                    }
                    console.log('üéôÔ∏è Speech recognition ended.');
                }
            };
        }

        function startVoiceInput() {
            const customQuestionInput = document.getElementById('customQuestion');
            customQuestionInput.focus();

            if (isListening) {
                recognition.stop();
            } else {
                try {
                    customQuestionInput.value = ""; 
                    recognition.start();
                } catch (e) {
                    console.error('Error starting speech recognition:', e);
                    if (e.message.includes('already started')) {
                        console.warn('Recognition already started, ignoring.');
                    } else {
                        addActivity('error', 'üéôÔ∏è', 'Voice Input Error', `Could not start microphone: ${e.message}`, { error: e.message });
                        showError(`Microphone error: ${e.message}. Check permissions.`);
                    }
                }
            }
        }
        // --- END Web Speech API Functions ---


        // Load demo users from API
        async function loadDemoUsers() {
            try {
                addActivity('connecting', 'üë•', 'Loading Demo Users', 'Attempting to load demo users from API...', { status: 'Loading' });
                
                const response = await fetch(`${API_BASE}/api/users`);
                const data = await response.json();
                
                if (data.success && data.users && data.users.length > 0) {
                    demoUsers = data.users;
                    renderUserButtons();
                    if (demoUsers.length > 0) {
                        switchUser(demoUsers[0].user_id);
                    }
                    addActivity('success', '‚úÖ', 'Demo Users Loaded', `Found ${demoUsers.length} demo users.`, { users: demoUsers.length });
                    console.log(`‚úÖ Loaded ${demoUsers.length} demo users`);
                } else {
                    throw new Error(data.error || 'Failed to load users from API, or no users returned.');
                }
            } catch (error) {
                console.error('‚ùå Error loading users from API:', error);
                addActivity('error', '‚ùå', 'Failed to Load Users', `API error: ${error.message}. Using fallback users.`, { status: 'Error' });
                addFallbackUsers(); 
            }
        }

        // Render user selection buttons
        function renderUserButtons() {
            const container = document.getElementById('userButtons');
            container.innerHTML = '';

            demoUsers.forEach(user => {
                const button = document.createElement('button');
                button.className = 'user-btn';
                button.setAttribute('data-user', user.user_id);
                button.onclick = () => switchUser(user.user_id);
                
                button.innerHTML = `
                    <div class="user-name">${user.avatar} ${user.name}</div>
                    <div class="user-type">${getProfileTypeLabel(user.profile_type)}</div>
                    <div class="user-preview">${user.description}</div>
                `;
                container.appendChild(button);
            });
        }

        // Get user-friendly profile type labels
        function getProfileTypeLabel(profileType) {
            const labels = {
                'first_buyer': 'First Home Buyer',
                'investor': 'Property Investor'
            };
            return labels[profileType] || profileType;
        }

        // Switch to different user
        async function switchUser(userId) {
            if (currentUser === userId) {
                console.log(`‚ÑπÔ∏è Already on user: ${userId}`);
                return; 
            }

            try {
                console.log(`üîÑ Switching to user: ${userId}`);
                currentUser = userId;
                const user = demoUsers.find(u => u.user_id === userId);
                
                document.querySelectorAll('.user-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`[data-user="${userId}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                } else {
                    console.warn(`User button not found for ${userId}`);
                }

                document.getElementById('userProfile').classList.add('loading');
                document.getElementById('sectionTitle').textContent = 'üîÑ Loading user data...';

                await loadUserStats(userId); // This now fetches max_session_tokens
                renderPresetQuestions(userId);
                
                document.getElementById('customInputSection').style.display = 'flex';
                document.getElementById('sectionTitle').textContent = `ü§ñ ${user.name}'s Property Analysis`;
                document.getElementById('results').style.display = 'none';

                addActivity('success', '‚úÖ', 'User Switched', `Successfully switched to ${user.name}'s profile.`, { user: user.name });
                console.log(`‚úÖ Successfully switched to ${user.name}`);
                
            } catch (error) {
                console.error('‚ùå Error switching user:', error);
                addActivity('error', '‚ùå', 'User Switch Failed', error.message, { status: 'Error' });
                showError('Failed to switch user');
            }
        }

        // Load user statistics
        async function loadUserStats(userId) {
            try {
                const response = await fetch(`${API_BASE}/api/users/${userId}/stats`);
                const data = await response.json();
                
                if (data.success) {
                    // Update global token variables from user stats
                    sessionTotalTokens = data.data.stats.total_tokens_used;
                    maxSessionTokens = data.data.stats.max_session_tokens; // Get limit from backend

                    updateUserProfile(data.data); // This function will now call updateTokenDisplay
                    addActivity('success', 'üìà', 'User Stats Loaded', `Analytics loaded for ${userId}: ${data.data.stats.total_queries} queries, ${data.data.stats.avg_processing_time}s avg time`, { 
                        user: userId,
                        queries: data.data.stats.total_queries,
                        time: `${data.data.stats.avg_processing_time}s`
                    });
                    console.log(`‚úÖ Loaded stats for ${userId}`);
                } else {
                    throw new Error(data.error || 'Failed to load user stats');
                }
            } catch (error) {
                console.error('‚ùå Error loading user stats:', error);
                addActivity('error', '‚ùå', 'Stats Load Failed', error.message, { status: 'Error' });
                showError('Failed to load user statistics');
            }
        }

        // Update user profile display
        function updateUserProfile(userData) {
            const profileContainer = document.getElementById('userProfile');
            profileContainer.classList.remove('loading');
            
            profileContainer.innerHTML = `
                <div class="user-avatar">${userData.user.avatar}</div>
                <h3>${userData.user.name}</h3>
                <div class="profile-type">${getProfileTypeLabel(userData.user.profile_type)}</div>
                <div class="user-description">${userData.user.description}</div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value">${userData.stats.total_queries}</div>
                        <div class="stat-label">Queries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${userData.stats.avg_processing_time}s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
                <div class="llm-usage-details" id="llmUsageDetails">
                    <h4>LLM Usage:</h4>
                    <div class="usage-meter">
                        <span id="questionTokens" class="token-count">Current Query: 0 tokens</span>
                        <span id="sessionTokens" class="token-count">Session Total: 0 / 0 tokens</span>
                        <div class="progress-bar-container">
                            <div id="sessionProgressBar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            `;

            updateQueryHistory(userData.recent_queries);
            updateTokenDisplay(); // NEW: Call to ensure token display is updated immediately after profile load
        }

        // Update query history display
        function updateQueryHistory(queries) {
            const historyContainer = document.getElementById('queryHistoryList');
            
            if (!queries || queries.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üÜï</span>
                        <p>No queries yet. Start by asking a question!</p>
                    </div>
                `;
                return;
            }

            historyContainer.innerHTML = '';
            
            queries.forEach(query => {
                const item = document.createElement('div');
                item.className = 'query-item fade-in';
                
                const timeAgo = getTimeAgo(query.created_at);
                
                item.innerHTML = `
                    <div class="query-question">${query.question}</div>
                    <div class="query-meta">
                        <span class="query-location">${query.location || 'National'}</span>
                        <span>${timeAgo} ‚Ä¢ ${query.processing_time}s</span>
                    </div>
                `;
                historyContainer.appendChild(item);
            });
        }

        // Get time ago string
        function getTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Render preset questions for current user
        async function renderPresetQuestions(userId) { 
            const container = document.getElementById('presetQuestions');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading personalized questions...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/api/property/questions?user_id=${userId}`);
                const data = await response.json();

                container.innerHTML = ''; 
                
                if (data.success && data.questions && data.questions.length > 0) {
                    data.questions.forEach(q => {
                        const buttonWrapper = document.createElement('div'); 
                        buttonWrapper.className = 'preset-btn-wrapper fade-in'; 

                        const button = document.createElement('button');
                        button.className = 'preset-btn'; 
                        button.textContent = q.question;
                        button.onclick = () => analyzeQuestion(q.question);
                        
                        let typeLabel = '';
                        if (q.type === 'recent_user') {
                            typeLabel = ' (Recent)';
                            button.classList.add('preset-btn-recent'); 
                        } else if (q.type === 'popular_global') {
                            typeLabel = ' (Popular)';
                            button.classList.add('preset-btn-popular'); 
                        } else if (q.type === 'example') {
                            typeLabel = ' (Example)';
                            button.classList.add('preset-btn-example'); 
                        }

                        const span = document.createElement('span');
                        span.className = 'preset-type-label';
                        span.textContent = typeLabel;
                        button.appendChild(span);

                        buttonWrapper.appendChild(button); 

                        if (q.type !== 'example' && q.query_id) { 
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-preset-btn';
                            deleteBtn.innerHTML = '&times;'; 
                            deleteBtn.title = `Delete "${q.question}"`;
                            deleteBtn.onclick = (event) => {
                                event.stopPropagation(); 
                                if (confirm(`Are you sure you want to delete this question: "${q.question}"?`)) {
                                    deleteQuestion(q.query_id); 
                                }
                            };
                            buttonWrapper.appendChild(deleteBtn);
                        }

                        container.appendChild(buttonWrapper); 
                    });
                    addActivity('success', '‚ùì', 'Questions Loaded', `Loaded ${data.questions.length} dynamic questions for ${userId}.`, { user: userId });
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="emoji">üìù</span>
                            <p>No recent questions yet. Ask a question or use the microphone to start!</p>
                            <p>Or check the console for fallback example questions.</p>
                        </div>
                    `;
                    addActivity('info', '‚ùì', 'Questions', 'No dynamic questions found, prompting user to ask.', { user: userId });
                    console.log("No dynamic questions found for user, prompting custom input.");
                }
            } catch (error) {
                console.error('‚ùå Error loading preset questions:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">‚ùó</span>
                        <p>Failed to load questions. Please try refreshing.</p>
                    </div>
                `;
                addActivity('error', '‚ùì', 'Questions Load Failed', `Error: ${error.message}.`, { user: userId });
            }
        }

        async function analyzeQuestion(question) {
            if (!currentUser) {
                alert('Please select a user first');
                return;
            }

            // NEW: Reset current query tokens and update display at the start of analysis
            currentQueryTokens = 0; 
            updateTokenDisplay(); 
            
            const user = demoUsers.find(u => u.user_id === currentUser);

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing property question for ${user?.name}...</p>
                </div>
            `;

            resultsDiv.scrollIntoView({ behavior: 'smooth' });

            try {
                console.log(`üîç Analyzing question for ${currentUser}: ${question}`);
                
                const response = await fetch(`${API_BASE}/api/property/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        user_id: currentUser
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const formattedAnswerHtml = marked.parse(data.answer || '');

                    resultsDiv.innerHTML = `
                        <div class="results fade-in">
                            <h3>üìã Analysis Results for ${user?.name}</h3>
                            <div class="analysis-content">${formattedAnswerHtml}</div>
                            <div class="metadata">
                                <div class="metadata-item">
                                    <span><strong>Location:</strong></span>
                                    <span>${data.metadata.location_detected}</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>Processing Time:</strong></span>
                                    <span>${data.processing_time}s</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>LLM Provider:</strong></span>
                                    <span>${data.metadata.llm_provider}</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>Confidence:</strong></span>
                                    <span>${Math.round(data.metadata.confidence * 100)}%</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>Query ID:</strong></span>
                                    <span>#${data.query_id}</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>User:</strong></span>
                                    <span>${currentUser}</span>
                                </div>
                                <div class="metadata-item">
                                    <span><strong>Total Tokens:</strong></span>
                                    <span>${data.total_tokens_used || 0}</span> </div>
                            </div>
                        </div>
                    `;

                    await loadUserStats(currentUser); 
                    await loadSystemStats();
                    
                    document.getElementById('customQuestion').value = ''; 
                    renderPresetQuestions(currentUser); 

                    console.log(`‚úÖ Analysis completed for ${currentUser}`);
                } else {
                    addActivity('error', '‚ùå', 'Analysis Failed', data.error || 'Unknown error occurred', { status: 'Error' });
                    
                    resultsDiv.innerHTML = `
                        <div class="results">
                            <h3>‚ùå Analysis Failed</h3>
                            <p>Sorry, we couldn't analyze your question. Please try again.</p>
                            <p class="error-details">${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error analyzing question:', error);
                addActivity('error', '‚ùå', 'Analysis Error', error.message, { status: 'Error' });
                
                resultsDiv.innerHTML = `
                    <div class="results">
                        <h3>‚ùå Error</h3>
                        <p>An error occurred while analyzing your question.</p>
                        <p class="error-details">${error.message}</p>
                    </div>
                `;
            }
        }

        // Function to delete a question
        async function deleteQuestion(queryId) {
            try {
                if (!queryId) {
                    addActivity('error', '‚ùå', 'Delete Question', 'Missing query ID for deletion.', { status: 'Error' });
                    return;
                }

                addActivity('processing', 'üóëÔ∏è', 'Deleting Question', `Attempting to delete query ID: ${queryId}...`, { query_id: queryId });

                const response = await fetch(`${API_BASE}/api/property/history/${queryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    addActivity('success', 'üóëÔ∏è', 'Question Deleted', `Query ID ${queryId} removed.`, { query_id: queryId });
                    renderPresetQuestions(currentUser); 
                    loadUserStats(currentUser); 
                } else {
                    throw new Error(data.error || 'Failed to delete question.');
                }
            } catch (error) {
                console.error('‚ùå Error deleting question:', error);
                addActivity('error', '‚ùå', 'Delete Question Failed', `Error: ${error.message}`, { query_id: queryId });
                showError(`Failed to delete question: ${error.message}`);
            }
        }

        // Analyze custom question (this just calls analyzeQuestion with input field content)
        function analyzeCustomQuestion() {
            const question = document.getElementById('customQuestion').value.trim();
            if (question) {
                analyzeQuestion(question);
            }
        }

        // Load system statistics for dashboard
        async function loadSystemStats() {
            try {
                const response = await fetch(`${API_BASE}/api/property/stats`);
                const data = await response.json();
                
                if (data.success && performanceChart) {
                    updatePerformanceChart(data.stats);
                    console.log('‚úÖ System stats updated');
                }
            } catch (error) {
                console.error('‚ùå Error loading system stats:', error);
            }
        }

        // Setup performance chart
        function setupPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Times (seconds)',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4facfe',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Recent Query Response Times by User',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (seconds)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Recent Queries'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Update performance chart with new data
        function updatePerformanceChart(stats) {
            if (!stats.llm_performance || !stats.llm_performance.response_times) {
                return;
            }

            const times = stats.llm_performance.response_times;
            
            if (times && times.length > 0) {
                const labels = times.map((_, index) => `Query ${index + 1}`);
                const data = times.map(item => item.processing_time);
                
                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = data;
                performanceChart.update('none'); 
            }
        }

        // NEW: Function to update token display in the UI
        function updateTokenDisplay() {
            const questionTokensElem = document.getElementById('questionTokens');
            const sessionTokensElem = document.getElementById('sessionTokens');
            const sessionProgressBar = document.getElementById('sessionProgressBar');
            const llmUsageDetailsPanel = document.getElementById('llmUsageDetails');

            if (questionTokensElem) {
                questionTokensElem.textContent = `Current Query: ${currentQueryTokens} tokens`;
            }
            
            if (sessionTokensElem && sessionProgressBar) {
                sessionTokensElem.textContent = `Session Total: ${sessionTotalTokens} / ${maxSessionTokens} tokens`;
                let percentage = (sessionTotalTokens / maxSessionTokens) * 100;
                if (isNaN(percentage) || !isFinite(percentage)) percentage = 0; 
                percentage = Math.min(percentage, 100); 
                sessionProgressBar.style.width = `${percentage}%`;

                sessionProgressBar.classList.remove('warning', 'critical');
                if (percentage > 70 && percentage <= 90) {
                    sessionProgressBar.classList.add('warning');
                } else if (percentage > 90) {
                    sessionProgressBar.classList.add('critical');
                }
            }

            if (llmUsageDetailsPanel) {
                llmUsageDetailsPanel.style.display = 'block'; // Ensure panel is visible
            }
        }


        // Error handling
        function showError(message) {
            console.error('‚ùå', message);
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: 600;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Enter key support for custom questions
        document.addEventListener('DOMContentLoaded', function() {
            const customQuestion = document.getElementById('customQuestion');
            if (customQuestion) {
                customQuestion.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        analyzeCustomQuestion();
                    }
                });
            }
        });

        // Auto-refresh system stats every 60 seconds
        setInterval(loadSystemStats, 60000);

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Add some demo data if no users loaded (fallback)
        function addFallbackUsers() {
            console.log('‚ÑπÔ∏è Using fallback demo users as API users not loaded.');
            demoUsers = [
                {
                    user_id: 'sarah_buyer',
                    name: 'Sarah Chen',
                    profile_type: 'first_buyer',
                    description: 'First home buyer focused on affordability and transport links',
                    avatar: 'üë©‚Äçüíº'
                },
                {
                    user_id: 'michael_investor',
                    name: 'Michael Rodriguez',
                    profile_type: 'investor',
                    description: 'Property investor focused on rental yield and growth',
                    avatar: 'üë®‚Äçüíª'
                }
            ];
            renderUserButtons();
            if (demoUsers.length > 0) {
                switchUser(demoUsers[0].user_id);
            }
            addActivity('success', 'üîÑ', 'Fallback Users Loaded', 'API users not available, using local demo data.', { status: 'Demo Mode' });
        }

        // Enhanced logging for debugging
        window.addEventListener('load', () => {
            console.log('üéâ Australian Property Intelligence V3 Frontend Loaded');
            console.log('üîó API Base:', API_BASE);
            console.log('üë• Demo Users:', demoUsers.length);
        });

        // Handle offline/online states
        window.addEventListener('online', () => {
            console.log('üåê Back online');
            addActivity('success', 'üåê', 'Connection Restored', 'Back online - all features available', { status: 'Online' });
            loadSystemStats();
        });

        window.addEventListener('offline', () => {
            console.log('üì° Gone offline');
            addActivity('error', 'üì°', 'Connection Lost', 'Offline mode - some features may not work', { status: 'Offline' });
            showError('Connection lost. Some features may not work.');
        });
    </script>
</body>
</html>